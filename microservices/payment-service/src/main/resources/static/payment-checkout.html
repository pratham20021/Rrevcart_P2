<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RevCart Payment</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        .payment-btn { background: #528FF0; color: white; padding: 15px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .payment-btn:hover { background: #3d7ad6; }
        .info { background: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>Complete Your Payment</h1>
    <div class="info">
        <p><strong>Order ID:</strong> <span id="orderId"></span></p>
        <p><strong>Amount:</strong> â‚¹<span id="amount"></span></p>
    </div>
    <button class="payment-btn" onclick="initiatePayment()">Pay Now</button>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('orderId') || '1001';
        const userId = urlParams.get('userId') || '1';
        const amount = urlParams.get('amount') || '500';

        document.getElementById('orderId').textContent = orderId;
        document.getElementById('amount').textContent = amount;

        async function initiatePayment() {
            try {
                const response = await fetch(`http://localhost:8086/payments/create-order?orderId=${orderId}&userId=${userId}&amount=${amount}`, {
                    method: 'POST'
                });
                const data = await response.json();

                const options = {
                    key: data.razorpayKeyId,
                    amount: data.amount * 100,
                    currency: data.currency,
                    name: 'RevCart',
                    description: 'Order Payment',
                    order_id: data.razorpayOrderId,
                    handler: async function (response) {
                        await verifyPayment(response);
                    },
                    prefill: {
                        name: 'Customer Name',
                        email: 'customer@example.com',
                        contact: '9999999999'
                    },
                    theme: { color: '#528FF0' },
                    config: {
                        display: {
                            blocks: {
                                banks: {
                                    name: 'All payment methods',
                                    instruments: [
                                        { method: 'upi' },
                                        { method: 'card' },
                                        { method: 'netbanking' },
                                        { method: 'wallet' }
                                    ]
                                }
                            },
                            sequence: ['block.banks'],
                            preferences: { show_default_blocks: true }
                        }
                    },
                    modal: {
                        ondismiss: function() {
                            alert('Payment cancelled');
                        }
                    }
                };

                const rzp = new Razorpay(options);
                rzp.open();
            } catch (error) {
                alert('Error initiating payment: ' + error.message);
            }
        }

        async function verifyPayment(response) {
            try {
                const verifyResponse = await fetch('http://localhost:8086/payments/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        razorpayOrderId: response.razorpay_order_id,
                        razorpayPaymentId: response.razorpay_payment_id,
                        razorpaySignature: response.razorpay_signature
                    })
                });

                if (verifyResponse.ok) {
                    const payment = await verifyResponse.json();
                    alert('Payment Successful! Transaction ID: ' + payment.transactionId);
                    window.location.href = '/payment-success.html?paymentId=' + payment.id;
                } else {
                    alert('Payment verification failed!');
                }
            } catch (error) {
                alert('Error verifying payment: ' + error.message);
            }
        }
    </script>
</body>
</html>
