<div class="checkout-container">
  <div class="container">
    <div class="checkout-header">
      <h1 class="page-title">
        <span class="neon-text">Checkout</span>
      </h1>
      <p class="page-subtitle">Complete your order in just a few steps</p>
    </div>
    
    <div class="checkout-content">
      <!-- Checkout Form -->
      <div class="checkout-form">
        <form (ngSubmit)="onSubmit()" #checkoutForm="ngForm">
          
          <!-- Personal Information -->
          <div class="form-section glass-card">
            <h3 class="section-title">
              <i class="fas fa-user"></i>
              Personal Information
            </h3>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Full Name *</label>
                <input 
                  type="text" 
                  class="form-control" 
                  [(ngModel)]="orderData.customerName"
                  name="customerName"
                  placeholder="Enter your full name"
                  required>
              </div>
              
              <div class="form-group">
                <label class="form-label">Email Address *</label>
                <input 
                  type="email" 
                  class="form-control" 
                  [(ngModel)]="orderData.email"
                  name="email"
                  placeholder="Enter your email"
                  required>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Phone Number *</label>
              <input 
                type="tel" 
                class="form-control" 
                [(ngModel)]="orderData.phone"
                name="phone"
                placeholder="Enter your phone number"
                required>
            </div>
          </div>
          
          <!-- Delivery Address -->
          <div class="form-section glass-card">
            <h3 class="section-title">
              <i class="fas fa-map-marker-alt"></i>
              Delivery Address
            </h3>
            
            <div class="form-group">
              <label class="form-label">Street Address *</label>
              <input 
                type="text" 
                class="form-control" 
                [(ngModel)]="orderData.address.street"
                name="street"
                placeholder="House/Flat number, Street name"
                required>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">City *</label>
                <input 
                  type="text" 
                  class="form-control" 
                  [(ngModel)]="orderData.address.city"
                  name="city"
                  placeholder="Enter city"
                  required>
              </div>
              
              <div class="form-group">
                <label class="form-label">Postal Code *</label>
                <input 
                  type="text" 
                  class="form-control" 
                  [(ngModel)]="orderData.address.postalCode"
                  name="postalCode"
                  placeholder="Enter postal code"
                  required>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Delivery Instructions (Optional)</label>
              <textarea 
                class="form-control" 
                [(ngModel)]="orderData.deliveryInstructions"
                name="deliveryInstructions"
                placeholder="Any special delivery instructions..."
                rows="3"></textarea>
            </div>
          </div>
          
          <!-- Payment Method -->
          <div class="form-section glass-card">
            <h3 class="section-title">
              <i class="fas fa-credit-card"></i>
              Payment Method
            </h3>
            
            <div class="payment-methods">
              <div class="payment-option" 
                   [class.selected]="orderData.paymentMethod === 'card'"
                   (click)="selectPaymentMethod('card')">
                <div class="payment-icon">
                  <i class="fas fa-credit-card"></i>
                </div>
                <div class="payment-details">
                  <h4>Credit/Debit Card</h4>
                  <p>Pay securely with your card</p>
                </div>
                <div class="payment-radio">
                  <input type="radio" name="paymentMethod" value="card" 
                         [(ngModel)]="orderData.paymentMethod">
                </div>
              </div>
              
              <div class="payment-option" 
                   [class.selected]="orderData.paymentMethod === 'upi'"
                   (click)="selectPaymentMethod('upi')">
                <div class="payment-icon">
                  <i class="fas fa-mobile-alt"></i>
                </div>
                <div class="payment-details">
                  <h4>UPI Payment</h4>
                  <p>Pay using UPI apps</p>
                </div>
                <div class="payment-radio">
                  <input type="radio" name="paymentMethod" value="upi" 
                         [(ngModel)]="orderData.paymentMethod">
                </div>
              </div>
              
              <div class="payment-option" 
                   [class.selected]="orderData.paymentMethod === 'cod'"
                   (click)="selectPaymentMethod('cod')">
                <div class="payment-icon">
                  <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="payment-details">
                  <h4>Cash on Delivery</h4>
                  <p>Pay when you receive your order</p>
                </div>
                <div class="payment-radio">
                  <input type="radio" name="paymentMethod" value="cod" 
                         [(ngModel)]="orderData.paymentMethod">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Place Order Button -->
          <div class="form-actions">
            <button 
              type="button" 
              class="btn btn-ghost"
              routerLink="/cart">
              <i class="fas fa-arrow-left"></i>
              Back to Cart
            </button>
            
            <button 
              type="submit" 
              class="btn btn-success"
              [disabled]="!checkoutForm.valid || isProcessing">
              <i class="fas fa-spinner fa-spin" *ngIf="isProcessing"></i>
              <i class="fas fa-check" *ngIf="!isProcessing"></i>
              {{ isProcessing ? 'Processing...' : 'Place Order' }}
            </button>
          </div>
        </form>
      </div>
      
      <!-- Order Summary -->
      <div class="order-summary glass-card">
        <h3 class="summary-title">
          <i class="fas fa-receipt"></i>
          Order Summary
        </h3>
        
        <div class="summary-items">
          <div class="summary-item" *ngFor="let item of cartItems">
            <div class="item-image">
              <img [src]="item.imageUrl" [alt]="item.name">
            </div>
            <div class="item-info">
              <h4>{{item.name}}</h4>
              <p>Qty: {{item.quantity}}</p>
            </div>
            <div class="item-price">
              ₹{{item.price * item.quantity}}
            </div>
          </div>
        </div>
        
        <div class="summary-totals">
          <div class="summary-row">
            <span>Items ({{getItemCount()}})</span>
            <span>₹{{getSubtotal()}}</span>
          </div>
          
          <div class="summary-row">
            <span>Delivery Fee</span>
            <span *ngIf="getDeliveryFee() > 0">₹{{getDeliveryFee()}}</span>
            <span *ngIf="getDeliveryFee() === 0" class="free-delivery">FREE</span>
          </div>
          
          <div class="delivery-info-text">
            <small class="free-delivery-message">
              <i class="fas fa-info-circle"></i>
              Delivery free if order is above ₹199
            </small>
          </div>
          
          <div class="summary-row">
            <span>GST (18%)</span>
            <span>₹{{getGST()}}</span>
          </div>
          
          <div class="coupon-section">
            <div class="coupon-header">
              <button type="button" class="btn-view-coupons" (click)="toggleCoupons()">
                <i class="fas fa-ticket-alt"></i>
                {{ showCoupons ? 'Hide' : 'View' }} Available Coupons ({{availableCoupons.length}})
              </button>
            </div>
            
            <div class="available-coupons" *ngIf="showCoupons">
              <div class="coupon-card" *ngFor="let coupon of availableCoupons" (click)="selectCoupon(coupon.code)">
                <div class="coupon-badge">
                  <i class="fas fa-tag"></i>
                </div>
                <div class="coupon-details">
                  <h4>{{coupon.code}}</h4>
                  <p>{{coupon.description}}</p>
                  <div class="coupon-value">
                    <span *ngIf="coupon.discountType === 'PERCENTAGE'">
                      {{coupon.discountValue}}% OFF
                    </span>
                    <span *ngIf="coupon.discountType === 'FIXED'">
                      ₹{{coupon.discountValue}} OFF
                    </span>
                  </div>
                  <div class="coupon-conditions" *ngIf="coupon.minOrderAmount">
                    <small>Min order: ₹{{coupon.minOrderAmount}}</small>
                  </div>
                  <div class="coupon-conditions" *ngIf="coupon.maxDiscountAmount && coupon.discountType === 'PERCENTAGE'">
                    <small>Max discount: ₹{{coupon.maxDiscountAmount}}</small>
                  </div>
                </div>
                <button type="button" class="btn-use-coupon">
                  Use
                </button>
              </div>
              <div class="no-coupons" *ngIf="availableCoupons.length === 0">
                <i class="fas fa-info-circle"></i>
                <p>No coupons available at the moment</p>
              </div>
            </div>
            
            <div class="coupon-input-group" *ngIf="!appliedCoupon">
              <input 
                type="text" 
                class="coupon-input" 
                [(ngModel)]="couponCode"
                placeholder="Enter coupon code"
                [ngModelOptions]="{standalone: true}">
              <button type="button" class="btn-apply-coupon" (click)="applyCoupon()">
                Apply
              </button>
            </div>
            <div class="coupon-applied" *ngIf="appliedCoupon">
              <div class="coupon-info">
                <i class="fas fa-check-circle"></i>
                <span>{{appliedCoupon.code}} applied</span>
              </div>
              <button type="button" class="btn-remove-coupon" (click)="removeCoupon()">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="coupon-error" *ngIf="couponError">
              <i class="fas fa-exclamation-circle"></i>
              {{couponError}}
            </div>
          </div>
          
          <div class="summary-row" *ngIf="couponDiscount > 0">
            <span class="discount-label">Coupon Discount</span>
            <span class="discount-value">-₹{{couponDiscount}}</span>
          </div>
          
          <div class="summary-divider"></div>
          
          <div class="summary-row total-row">
            <span>Total</span>
            <span>₹{{getTotal()}}</span>
          </div>
        </div>
        
        <div class="delivery-info">
          <div class="delivery-time">
            <i class="fas fa-clock"></i>
            <span>Estimated delivery: 30-45 minutes</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- UPI Payment Modal -->
<div class="modal-overlay" *ngIf="showUpiModal">
  <div class="modal-content upi-modal">
    <div class="modal-header">
      <h3>UPI Payment</h3>
      <button class="close-btn" (click)="closeUpiModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="upi-content">
        <div class="payment-amount">
          <h2>₹{{getTotal()}}</h2>
          <p>Scan QR code to pay</p>
        </div>
        <div class="qr-code">
          <div class="qr-placeholder">
            <i class="fas fa-qrcode"></i>
            <p>QR Code</p>
            <small>Scan with any UPI app</small>
          </div>
        </div>
        <div class="upi-instructions">
          <p>1. Open any UPI app (GPay, PhonePe, Paytm, etc.)</p>
          <p>2. Scan the QR code above</p>
          <p>3. Enter your UPI PIN to complete payment</p>
          <p>4. Click 'Done' after successful payment</p>
        </div>
        <button class="btn btn-success w-full" (click)="completeUpiPayment()">
          <i class="fas fa-check"></i>
          Done - Payment Completed
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Invoice Modal -->
<div class="modal-overlay" *ngIf="showInvoice">
  <div class="modal-content invoice-modal">
    <div class="modal-header">
      <h3>Invoice</h3>
      <button class="close-btn" (click)="closeInvoice()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="invoice" #invoiceContent>
        <div class="invoice-header">
          <h1>RevCart</h1>
          <p>Premium Grocery Delivery</p>
        </div>
        <div class="invoice-details">
          <div class="invoice-info">
            <h3>Invoice #{{invoiceData?.orderId}}</h3>
            <p>Date: {{invoiceData?.orderDate | date:'medium'}}</p>
          </div>
          <div class="customer-info">
            <h4>Bill To:</h4>
            <p>{{invoiceData?.customerName}}</p>
            <p>{{invoiceData?.email}}</p>
            <p>{{invoiceData?.phone}}</p>
          </div>
        </div>
        <div class="invoice-items">
          <table>
            <thead>
              <tr>
                <th>Item</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of invoiceData?.items">
                <td>{{item.name}}</td>
                <td>{{item.quantity}}</td>
                <td>₹{{item.price}}</td>
                <td>₹{{item.price * item.quantity}}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="invoice-totals">
          <div class="total-row">
            <span>Subtotal:</span>
            <span>₹{{invoiceData?.subtotal}}</span>
          </div>
          <div class="total-row">
            <span>Delivery Fee:</span>
            <span>₹{{invoiceData?.deliveryFee}}</span>
          </div>
          <div class="total-row">
            <span>GST (18%):</span>
            <span>₹{{invoiceData?.gst}}</span>
          </div>
          <div class="total-row" *ngIf="invoiceData?.couponDiscount > 0" style="color: #2ecc71;">
            <span>Coupon Discount ({{invoiceData?.couponCode}}):</span>
            <span>-₹{{invoiceData?.couponDiscount}}</span>
          </div>
          <div class="total-row final-total">
            <span>Total:</span>
            <span>₹{{invoiceData?.total}}</span>
          </div>
        </div>
        <div class="invoice-footer">
          <p>Payment Method: {{invoiceData?.paymentMethod | uppercase}}</p>
          <p>Thank you for shopping with RevCart!</p>
        </div>
      </div>
      <div class="invoice-actions">
        <button class="btn btn-outline" (click)="downloadInvoice()">
          <i class="fas fa-download"></i>
          Download PDF
        </button>
        <button class="btn btn-primary" (click)="closeInvoice()">
          <i class="fas fa-check"></i>
          Done
        </button>
      </div>
    </div>
  </div>
</div>